<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>សាលា អន្តរជាតិ អាយធីឃេ</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="firebase-config.js"></script>
</head>

<body>
    <h1>Creating Admin User...</h1>
    <div id="status">Initializing...</div>
    <script>
        const email = "adminitk@gmail.com";
        const password = "123456";
        const role = "Admin"; // Based on request "សិទ្ធអ្នកគ្រប់គ្រង់"

        const statusDiv = document.getElementById('status');

        async function createAdmin() {
            try {
                // Initialize if not already (it should be in firebase-config.js but we double check)
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }

                statusDiv.innerHTML = "Creating user in Authentication...";

                try {
                    await firebase.auth().createUserWithEmailAndPassword(email, password);
                } catch (e) {
                    if (e.code === 'auth/email-already-in-use') {
                        statusDiv.innerHTML += "<br>User already exists in Auth, attempting to update database permissions...";
                        // If user exists, we might need to sign in to get UID or just find them if we were admin?
                        // But we can't search by email without admin SDK.
                        // However, if we just want to ensure the DB entry exists, we might need the UID.
                        // Let's try to sign in.
                        await firebase.auth().signInWithEmailAndPassword(email, password);
                    } else {
                        throw e;
                    }
                }

                const user = firebase.auth().currentUser;
                if (!user) {
                    throw new Error("Could not get current user.");
                }

                statusDiv.innerHTML += "<br>User UID: " + user.uid;
                statusDiv.innerHTML += "<br>Setting database entry...";

                // All permissions true for admin logic? 
                // In user-management.js, admins are checked by email 'admin@school.com' but also permissions.
                // The prompt says "សិទ្ធអ្នកគ្រប់គ្រង់" (Rights: Administrator).
                // Let's give all permissions and set role to Admin.

                await firebase.database().ref('users/' + user.uid).set({
                    email: email,
                    role: 'Admin', // Using 'Admin' as requested, though user-management.js checks 'staff' or 'admin@school.com'
                    permissions: {
                        dashboard: true,
                        registration: true,
                        data: true,
                        inventory: true
                    },
                    createdAt: new Date().toISOString()
                });

                statusDiv.innerHTML += "<br><strong style='color:green'>SUCCESS! Admin user created. Email: " + email + "</strong>";
                console.log("SUCCESS_ADMIN_USER_CREATED"); // For the browser agent to see

            } catch (error) {
                statusDiv.innerHTML += "<br><strong style='color:red'>ERROR: " + error.message + "</strong>";
                console.error(error);
            }
        }

        createAdmin();
    </script>
</body>

</html>