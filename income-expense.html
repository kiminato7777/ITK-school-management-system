<!DOCTYPE html>
<html lang="km">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ចំណូលចំណាយ - TIK School Management</title>
    <link rel="icon" type="image/jpeg" href="img/1.jpg">
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <link rel='stylesheet'
        href='https://cdn-uicons.flaticon.com/2.1.0/uicons-regular-rounded/css/uicons-regular-rounded.css'>
    <!-- Custom CSS -->
    <script src="global-settings.js" defer></script>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

    <style>
        /* Custom Styles for Income/Expense */
        .card-stats {
            transition: transform 0.3s;
            border: none;
            border-radius: 15px;
            overflow: hidden;
        }

        .card-stats:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .card-income {
            background: linear-gradient(45deg, #198754, #20c997);
            color: white;
        }

        .card-expense {
            background: linear-gradient(45deg, #dc3545, #f06595);
            color: white;
        }

        .card-balance {
            background: linear-gradient(45deg, #0d6efd, #0dcaf0);
            color: white;
        }

        .transaction-type-radio .btn-check:checked+.btn {
            border-width: 2px;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .transaction-list-item {
            transition: background-color 0.2s;
        }

        .transaction-list-item:hover {
            background-color: #f8f9fa;
        }

        .amount-income {
            color: #198754;
            font-weight: bold;
        }

        .amount-expense {
            color: #dc3545;
            font-weight: bold;
        }

        .category-icon {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background-color: #f0f2f5;
        }
    </style>
</head>

<body>

    <!-- Sidebar (Consistent with other pages) -->
    <div id="sidebar">
        <div class="sidebar-header">
            <a href="index.html">
                <img src="img/logo.jpg" alt="School Logo" id="sidebar-logo">
            </a>
            <span class="sidebar-title-text">
                <i class="fi fi-rr-graduation-cap"></i> ប្រព័ន្ធគ្រប់គ្រង
            </span>
        </div>
        <nav class="nav flex-column">
            <a class="nav-link" href="index.html">
                <i class="fi fi-rr-dashboard"></i> ផ្ទាំងគ្រប់គ្រង
            </a>

            <a class="nav-link" href="registration.html">
                <i class="fi fi-rr-user-add"></i> ការចុះឈ្មោះសិស្ស
            </a>

            <a class="nav-link" href="data-tracking.html">
                <i class="fi fi-rr-users-alt"></i> បញ្ជីទិន្នន័យសិស្ស
            </a>

            <a class="nav-link" href="dropout-students.html">
                <i class="fi fi-rr-user-xmark"></i> សិស្សបោះបង់ការសិក្សា
            </a>

            <a class="nav-link active" href="income-expense.html">
                <i class="fi fi-rr-file-invoice-dollar"></i> ចំណូលចំណាយ
            </a>

            <a class="nav-link" href="settings.html">
                <i class="fi fi-rr-settings"></i> ការកំណត់ (Setting)
            </a>

            <a class="nav-link" href="user-management.html" id="navUserManagement">
                <i class="fi fi-rr-shield-check"></i> គ្រប់គ្រងអ្នកប្រើប្រាស់
            </a>

            <hr class="sidebar-divider my-2 mx-3" style="border-top: 1px solid rgba(255,255,255,0.3);">

            <!-- User Profile Section -->
            <div class="px-3 py-2 text-white">
                <div class="d-flex flex-column align-items-center mb-2">
                    <div class="bg-white rounded-circle d-flex align-items-center justify-content-center mb-2 shadow-sm"
                        style="width: 50px; height: 50px;">
                        <i class="fi fi-rr-user text-primary" style="font-size: 1.5rem;"></i>
                    </div>
                    <div style="font-size: 0.9rem; width: 100%; text-align: center;">
                        <div class="fw-bold text-truncate" id="user-display-email">...</div>
                        <div class="badge bg-light text-primary mt-1" id="user-role-badge" style="font-weight: normal;">
                            ...</div>
                        <div class="small text-white-50 mt-1 text-truncate" id="user-display-gmail"
                            style="font-size: 0.8rem;">...</div>
                    </div>
                </div>
            </div>

            <a class="nav-link text-warning mt-1" href="#" id="logout-link" onclick="handleLogout(event)">
                <i class="fi fi-rr-exit"></i> ចាកចេញ
            </a>
        </nav>
    </div>

    <!-- Main Content -->
    <div id="main-content">
        <!-- Header -->
        <div
            class="d-flex justify-content-between align-items-center mb-4 main-header bg-white shadow-sm p-3 rounded-4">
            <div class="header-title">
                <h2 class="fs-3 m-0 text-primary title-font"><i
                        class="fi fi-rr-file-invoice-dollar me-2"></i>គ្រប់គ្រងចំណូលចំណាយ</h2>
                <p class="text-muted small mb-0 ms-1">Income & Expense Management</p>
            </div>

            <div class="d-flex gap-2">
                <div class="dropdown">
                    <button class="btn btn-outline-success shadow-sm rounded-pill px-4 dropdown-toggle" type="button"
                        data-bs-toggle="dropdown">
                        <i class="fi fi-rr-file-export me-2"></i> ទាញរបាយការណ៍
                    </button>
                    <ul class="dropdown-menu shadow border-0 rounded-3">
                        <li><a class="dropdown-item" href="#" onclick="exportReport('daily', 'pdf')"><i
                                    class="fi fi-rr-file-pdf text-danger me-2"></i>ប្រចាំថ្ងៃ (PDF)</a></li>
                        <li><a class="dropdown-item" href="#" onclick="exportReport('monthly', 'pdf')"><i
                                    class="fi fi-rr-file-pdf text-danger me-2"></i>ប្រចាំខែ (PDF)</a></li>
                        <li><a class="dropdown-item" href="#" onclick="exportReport('yearly', 'pdf')"><i
                                    class="fi fi-rr-file-pdf text-danger me-2"></i>ប្រចាំឆ្នាំ (PDF)</a></li>
                        <li>
                            <hr class="dropdown-divider">
                        </li>
                        <li><a class="dropdown-item" href="#" onclick="exportReport('daily', 'excel')"><i
                                    class="fi fi-rr-file-spreadsheet text-success me-2"></i>ប្រចាំថ្ងៃ (Excel)</a></li>
                        <li><a class="dropdown-item" href="#" onclick="exportReport('monthly', 'excel')"><i
                                    class="fi fi-rr-file-spreadsheet text-success me-2"></i>ប្រចាំខែ (Excel)</a></li>
                        <li><a class="dropdown-item" href="#" onclick="exportReport('yearly', 'excel')"><i
                                    class="fi fi-rr-file-spreadsheet text-success me-2"></i>ប្រចាំឆ្នាំ (Excel)</a></li>
                    </ul>
                </div>
                <button class="btn btn-primary shadow-sm rounded-pill px-4" data-bs-toggle="modal"
                    data-bs-target="#addTransactionModal">
                    <i class="fi fi-rr-plus-circle me-2"></i> បញ្ចូលប្រតិបត្តិការថ្មី
                </button>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="row g-4 mb-4" style="display: none;">
            <div class="col-md-4">
                <div class="card card-stats card-income h-100">
                    <div class="card-body p-4 d-flex align-items-center justify-content-between">
                        <div>
                            <h6 class="text-white-50 text-uppercase fw-bold mb-2">ចំណូលសរុប (Income)</h6>
                            <h2 class="fw-bold mb-0" id="totalIncome">$0.00</h2>
                        </div>
                        <div class="rounded-circle bg-white bg-opacity-25 p-3">
                            <i class="fi fi-rr-arrow-trend-up" style="font-size: 1.5rem;"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card card-stats card-expense h-100">
                    <div class="card-body p-4 d-flex align-items-center justify-content-between">
                        <div>
                            <h6 class="text-white-50 text-uppercase fw-bold mb-2">ចំណាយសរុប (Expense)</h6>
                            <h2 class="fw-bold mb-0" id="totalExpense">$0.00</h2>
                        </div>
                        <div class="rounded-circle bg-white bg-opacity-25 p-3">
                            <i class="fi fi-rr-arrow-trend-down" style="font-size: 1.5rem;"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card card-stats card-balance h-100">
                    <div class="card-body p-4 d-flex align-items-center justify-content-between">
                        <div>
                            <h6 class="text-white-50 text-uppercase fw-bold mb-2">សមតុល្យ (Balance)</h6>
                            <h2 class="fw-bold mb-0" id="netBalance">$0.00</h2>
                        </div>
                        <div class="rounded-circle bg-white bg-opacity-25 p-3">
                            <i class="fi fi-rr-wallet" style="font-size: 1.5rem;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters and Search -->
        <div class="card shadow-sm border-0 rounded-4 mb-4">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="input-group">
                            <span class="input-group-text bg-white border-end-0"><i
                                    class="fi fi-rr-search text-muted"></i></span>
                            <input type="text" class="form-control border-start-0 ps-0" id="searchTransaction"
                                placeholder="ស្វែងរកតាមការពិពណ៌នា...">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="input-group">
                            <span class="input-group-text bg-light"><i class="fi fi-rr-filter text-muted"></i></span>
                            <select class="form-select" id="filterType">
                                <option value="all">ទាំងអស់ (All Types)</option>
                                <option value="income">ចំណូល (Income)</option>
                                <option value="expense">ចំណាយ (Expense)</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="input-group">
                            <span class="input-group-text bg-light"><i
                                    class="fi fi-rr-calendar-day text-muted"></i></span>
                            <input type="text" class="form-control" id="dateRangeFilter"
                                placeholder="ជ្រើសរើសកាលបរិច្ឆេទ">
                        </div>
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-outline-secondary w-100" id="clearFilters">
                            <i class="fi fi-rr-refresh me-1"></i> សម្អាត
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Transactions List -->
        <div class="card shadow-lg border-0 rounded-4">
            <div class="card-header bg-white py-3">
                <h5 class="fw-bold m-0 text-primary title-font"><i
                        class="fi fi-rr-list me-2"></i>បញ្ជីប្រតិបត្តិការថ្មីៗ</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light text-secondary">
                            <tr>
                                <th class="px-4 py-3"><i class="fi fi-rr-calendar-day me-2"></i>កាលបរិច្ឆេទ</th>
                                <th class="py-3"><i class="fi fi-rr-text me-2"></i>ការពិពណ៌នា</th>
                                <th class="py-3"><i class="fi fi-rr-apps me-2"></i>ប្រភេទ</th>
                                <th class="py-3"><i class="fi fi-rr-list-check me-2"></i>ប្រភេទរង (Category)</th>
                                <th class="py-3 text-end"><i class="fi fi-rr-dollar me-2"></i>ចំនួនទឹកប្រាក់</th>
                                <th class="py-3"><i class="fi fi-rr-user me-2"></i>អ្នកបញ្ចូល</th>
                                <th class="py-3 text-center"><i class="fi fi-rr-settings-sliders me-2"></i>សកម្មភាព</th>
                            </tr>
                        </thead>
                        <tbody id="transactionsTableBody">
                            <tr>
                                <td colspan="7" class="text-center py-5 text-muted">
                                    <div class="spinner-border text-primary mb-3" role="status"></div>
                                    <p>កំពុងផ្ទុកទិន្នន័យ...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card-footer bg-white border-0 py-3">
                <nav aria-label="Page navigation">
                    <ul class="pagination justify-content-end mb-0" id="paginationControls">
                        <!-- Pagination will be generated here -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>

    <!-- Add Transaction Modal -->
    <div class="modal fade" id="addTransactionModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 rounded-4 shadow">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title fw-bold"><i class="fi fi-rr-plus-circle me-2"></i>បន្ថែមចំណូល ឬ ចំណាយថ្មី
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body p-4">
                    <form id="transactionForm">
                        <!-- Type Selection -->
                        <div class="mb-4 text-center">
                            <label class="form-label fw-bold d-block mb-2">ជ្រើសរើសប្រភេទ (Type)</label>
                            <div class="btn-group w-100 transaction-type-radio" role="group">
                                <input type="radio" class="btn-check" name="type" id="typeIncome" value="income"
                                    checked>
                                <label class="btn btn-outline-success py-2" for="typeIncome">
                                    <i class="fi fi-rr-arrow-trend-up me-2"></i>ចំណូល (Income)
                                </label>

                                <input type="radio" class="btn-check" name="type" id="typeExpense" value="expense">
                                <label class="btn btn-outline-danger py-2" for="typeExpense">
                                    <i class="fi fi-rr-arrow-trend-down me-2"></i>ចំណាយ (Expense)
                                </label>
                            </div>
                        </div>

                        <div class="row g-3">
                            <!-- Amount -->
                            <div class="col-md-6">
                                <label class="form-label fw-bold">ចំនួនទឹកប្រាក់ ($)</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fi fi-rr-dollar"></i></span>
                                    <input type="number" class="form-control fw-bold" id="amount" placeholder="0.00"
                                        step="0.01" required>
                                </div>
                            </div>

                            <!-- Date -->
                            <div class="col-md-6">
                                <label class="form-label fw-bold">កាលបរិច្ឆេទ</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fi fi-rr-calendar-day"></i></span>
                                    <input type="text" class="form-control" id="transactionDate"
                                        placeholder="YYYY-MM-DD" required>
                                </div>
                            </div>

                            <!-- Category -->
                            <div class="col-12">
                                <label class="form-label fw-bold"><i class="fi fi-rr-tags me-1"></i>ប្រភេទចំណូល/ចំណាយ
                                    (Category)</label>
                                <select class="form-select" id="category" required>
                                    <!-- Options will be populated by JS -->
                                </select>
                            </div>

                            <!-- Description -->
                            <div class="col-12">
                                <label class="form-label fw-bold"><i class="fi fi-rr-text me-1"></i>ការពិពណ៌នា
                                    (Description)</label>
                                <textarea class="form-control" id="description" rows="3"
                                    placeholder="សរសេរការកត់សម្គាល់..."></textarea>
                            </div>

                            <!-- Reference -->
                            <div class="col-12">
                                <label class="form-label fw-bold small text-muted"><i
                                        class="fi fi-rr-receipt me-1"></i>លេខយោង/វិក្កយបត្រ (Reference ID) -
                                    មិនចាំបាច់</label>
                                <input type="text" class="form-control form-control-sm" id="referenceId"
                                    placeholder="Ref #">
                            </div>
                        </div>

                        <div class="d-grid mt-4">
                            <button type="submit" class="btn btn-primary py-2 fw-bold shadow-sm">
                                <i class="fi fi-rr-disk me-2"></i> រក្សាទុក
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Transaction Modal -->
    <div class="modal fade" id="editTransactionModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 rounded-4 shadow">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title fw-bold"><i class="fi fi-rr-edit me-2"></i>កែប្រែប្រតិបត្តិការ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-4">
                    <form id="editTransactionForm">
                        <input type="hidden" id="editId">
                        <div class="mb-4 text-center">
                            <label class="form-label fw-bold d-block mb-2">ប្រភេទ (Type)</label>
                            <div class="btn-group w-100 transaction-type-radio" role="group">
                                <input type="radio" class="btn-check" name="editType" id="editTypeIncome"
                                    value="income">
                                <label class="btn btn-outline-success py-2" for="editTypeIncome">
                                    <i class="fi fi-rr-arrow-trend-up me-2"></i>ចំណូល
                                </label>

                                <input type="radio" class="btn-check" name="editType" id="editTypeExpense"
                                    value="expense">
                                <label class="btn btn-outline-danger py-2" for="editTypeExpense">
                                    <i class="fi fi-rr-arrow-trend-down me-2"></i>ចំណាយ
                                </label>
                            </div>
                        </div>

                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">ចំនួនទឹកប្រាក់ ($)</label>
                                <input type="number" class="form-control fw-bold" id="editAmount" step="0.01" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">កាលបរិច្ឆេទ</label>
                                <input type="text" class="form-control" id="editDate" required>
                            </div>
                            <div class="col-12">
                                <label class="form-label fw-bold">ប្រភេទ (Category)</label>
                                <select class="form-select" id="editCategory" required></select>
                            </div>
                            <div class="col-12">
                                <label class="form-label fw-bold">ការពិពណ៌នា</label>
                                <textarea class="form-control" id="editDescription" rows="3"></textarea>
                            </div>
                        </div>

                        <div class="d-grid mt-4">
                            <button type="submit"
                                class="btn btn-warning py-2 fw-bold shadow-sm">រក្សាទុកការកែប្រែ</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Export Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <script src="firebase-config.js"></script>
    <script src="auth-check.js"></script>
    <script src="khmer-font.js"></script>
    <script src="income-expense-script.js"></script>

</body>

</html>